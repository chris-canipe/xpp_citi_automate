<html><head><title>XPP::CITI::Automate</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" type="text/css" title="pod_stylesheet" href="http://acuxapsprod.rrd.com/perl_modules/style.css">

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.13,
  using Pod::Simple::PullParser v3.13,
  under Perl v5.010000 at Thu Feb 17 20:41:56 2011 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<a name='___top' class='dummyTopAnchor' ></a>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#TERMINOLOGY'>TERMINOLOGY</a>
  <li class='indexItem indexItem1'><a href='#SETUP'>SETUP</a>
  <li class='indexItem indexItem1'><a href='#DEFAULTS'>DEFAULTS</a>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <li class='indexItem indexItem1'><a href='#ERROR_REPORTING'>ERROR REPORTING</a>
  <li class='indexItem indexItem1'><a href='#SORTING'>SORTING</a>
  <li class='indexItem indexItem1'><a href='#EXAMPLES'>EXAMPLES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Single-Level'>Single-Level</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Before'>Before</a>
      <li class='indexItem indexItem3'><a href='#After_(with_defaults)'>After (with defaults)</a>
      <li class='indexItem indexItem3'><a href='#After_(with_initial_lettering)'>After (with initial lettering)</a>
      <li class='indexItem indexItem3'><a href='#After_(with_custom_initial_lettering(8212)2_leading_letters_or_digits)'>After (with custom initial lettering&#8212;2 leading letters or digits)</a>
      <li class='indexItem indexItem3'><a href='#After_(with_initial_lettering_and_modifiers_to_initial_cap_and_group_numerics)'>After (with initial lettering and modifiers to initial cap and group numerics)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Single-Level_using_2_mult-part_page_numbers_(p3_and_p4)'>Single-Level using 2 mult-part page numbers (p3 and p4)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Before'>Before</a>
      <li class='indexItem indexItem3'><a href='#After_(with_a_differently_formatted_p3_and_initial_lettering)'>After (with a differently formatted p3 and initial lettering)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Multi-Level'>Multi-Level</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Before'>Before</a>
      <li class='indexItem indexItem3'><a href='#After_(with_defaults)'>After (with defaults)</a>
      <li class='indexItem indexItem3'><a href='#After_(with_selective_initial_lettering)'>After (with selective initial lettering)</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#HISTORY'>HISTORY</a>
  <li class='indexItem indexItem1'><a href='#WHERE_IS_THIS_USED%3F'>WHERE IS THIS USED?</a>
  <li class='indexItem indexItem1'><a href='#HOW_IS_THIS_BEING_USED%3F'>HOW IS THIS BEING USED?</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#CHANGELOG'>CHANGELOG</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>XPP::CITI::Automate -- Automates the formatting and parsing of CITI extracts.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>In its simplest form:</p>

<pre>  #!/usr/local/bin/perl
  use warnings;
  use strict;
  use lib &#39;/usr/local/lib/perl_aps&#39;;
  use XPP::CITI::Automate;

  XPP::CITI::Automate-&#62;new-&#62;process;</pre>

<p>In its verbose (if not sane) form:</p>

<pre>  #!/usr/local/bin/perl
  use warnings;
  use strict;
  use lib &#39;/usr/local/lib/perl_aps&#39;;
  use XPP::CITI::Automate;

  XPP::CITI::Automate-&#62;new(
        pages =&#62; [qw(p3:ABC:{section} p4:rn:{page})],
        initial_case_sensitive =&#62; 0,
        initial_ignore_diacritics =&#62; 0,
        initial_prefix =&#62; &#39;{idx_initial}&#39;,
        initial_re =&#62; &#39;(Mc|[\p{L}\p{N}])&#39;,
        initial_candidates =&#62; [qw(
                {tag*}
                &#60;macro&#62;
        )],
        modifier =&#62; sub {
                 my $final = shift;
                if ($final) {
                        ### Modify the data at the very end of the process.
                }
                else {
                        ### Modify the data prior to initializing.
                }
        },
        move_uninitialized_to_top =&#62; 1,
        strip_eb_ep =&#62; 1,
        strip_keeps =&#62; 1,
        strip_pgafs =&#62; 1,
        tmp_dir =&#62; &#39;/tmp&#39;,
        debug =&#62; 1,
)-&#62;process;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p><code>XPP::CITI::Automate</code> parses and reformats CITI extracts.</p>

<p>It:</p>

<ol>
<li>Can be used for jobs that are set in &#34;Classic&#34; or XML; however, it only outputs &#34;Classic&#34; XPP codes.</li>

<li>Is set up in a Perl script and called as one of CITI&#39;s processes.</li>

<li>Is Unicode-friendly.</li>

<li>Handles the transformation of <code>&#60;rsv&#62;</code> macros into friendlier formats. The user can control which multi-part page numbers are used (p1-p6), what print-style (format) they&#39;re output as (arabic numeral, roman numeral, alpha character, etc.), and what they&#39;re prefixed by (generally a tag). Page numbers are automatically separated by a comma and a space (1, 3, 5), ranged (1-5), or a mix of the two (1, 3-5).</li>

<li>Handles initial lettering&#8212;putting &#34;A&#34; above the A&#39;s, &#34;B&#34; above the B&#39;s, etc. The user can control if it&#39;s executed or not, which candidates (tags or macros) are initialized, which characters are used for initializing (it can be letters and digits, <i>any</i> character, or even multiple characters), and what the initial is prefixed by (again, generally a tag).</li>

<li>Strips elements that are generally of no import to indexing, such as pgrafs, keeps (<code>&#60;ks&#62;</code>, <code>&#60;ke&#62;</code>, <code>&#60;vk&#62;</code>) and breaks (<code>&#60;eb&#62;</code>, <code>&#60;ep&#62;</code>).</li>

<li>Allows global modifications to be made.</li>
</ol>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="TERMINOLOGY"
>TERMINOLOGY</a></h1>

<p>candidates</p>

<blockquote>
<p>By default all prefixes are included in the initializing process. When more than one level is present in the extract you can control which are initialized and this is done by specifying candidates. For example, if your tags are <code>{level_one}</code> and <code>{level_two}</code>, you can restrict the initializing to <code>{level_one}</code> by specifying it as a candidate:</p>

<pre>  initial_candidates =&#62; [qw(
        {level_one}
  )]</pre>

<p>Similar to CITI&#39;s functionality, you may use an asterisk to include tags or macros that have attributes:</p>

<pre>  initial_candidates =&#62; [qw(
        {level_one*}
  )]</pre>

<p>Lastly, multiple candidates are valid:</p>

<pre>  initial_candidates =&#62; [qw(
        {level_one*}
        &#60;level_one*&#62;
  )]</pre>
</blockquote>

<p>initializing; initial lettering</p>

<blockquote>
<p>The process of generating initials from strings; e.g., &#34;A&#34; is the initial of &#34;Apple&#34;, &#34;B&#34; the initial of &#34;Banana&#34;, &#34;1&#34; the intial of &#34;123&#34;, etc. This is customizable and not restricted to one character or alpha characters. Also, any candidates that were not initialized (because they didn&#39;t match the pattern&#8212;punctuation, for instance) will be placed at the beginning of the file. This is done to prevent erroneous intermixing and it can be disabled if needed.</p>
</blockquote>

<p>prefix</p>

<blockquote>
<p>This is synonymous to CITI&#39;s &#34;Insert String&#34; field&#8212;the content (generally a tag, possibly a macro) that is inserted before the extracted data.</p>
</blockquote>

<p>print-style</p>

<blockquote>
<p>These are described under <code>&#60;ri&#62;</code> in the XyMacro documentation.</p>
</blockquote>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SETUP"
>SETUP</a></h1>

<p>Four things must be done to use this module:</p>

<ol>
<li>A Perl script must be created that uses this module.</li>

<li>The Language field in the CITI spec must be populated. This enables XPP&#39;s Unicode libraries (ICU), converts the incoming data to UTF-8, and informs the sort process (if any) that it needs to use Unicode collation.</li>

<li>The highest level that you extract must have an RSV Macro Form that is not &#34;<code>none</code>&#34; as <code>&#60;rsv&#62;</code> macros are required for parsing. If for some reason you do not need to display page numbers simply suppress them within the XPP styles or remove them using the <code>modifier</code> feature.</li>

<li>The Perl script must be called from one of the Process Name slots in the CITI spec. It should appear prior to <code>toxsf</code> and <code>compose</code> and come after any sort and/or dedupe processes.
<br><br><img src="images/setup.jpg">

</li>
</ol>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DEFAULTS"
>DEFAULTS</a></h1>

<p>By default the module does the following:</p>

<ol>
<li>Extracts the p4 multi-part page number from the <code>&#60;rsv&#62;</code> macros, prefixes them with a <code>{p4}</code> tag, and outputs them as arabic numerals.</li>

<li>Strips pgrafs, keeps, and breaks.</li>

<li>Creates intermediate files in <code>/tmp</code> and removes them automatically.</li>
</ol>

<p>When initial lettering is activated it has the following defaults:</p>

<ol>
<li>Only the first letter or digit of any entry (because there are no candidates) is initialized.</li>

<li>Case is ignored.</li>

<li>Diacritics are ignored.</li>

<li>Any entries that are not initialized are moved to the top of the file.</li>
</ol>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<dl>
<dt><a name="new"
>new</a></dt>

<dd>
<p>Creates the object and defines its parameters:</p>

<dl>
<dt><a name="debug"
>debug</a></dt>

<dd>
<p>A boolean that controls debugging. When enabled the script outputs the name of the temporary files that are created and does not remove them automatically. Do <b>not</b> leave this option on after debugging as it will retain a slew of unecessary files. This defaults to 0.</p>

<dt><a name="initial_candidates"
>initial_candidates</a></dt>

<dd>
<p>This is supplied as an array reference and each element specifies a candidate. See &#34;candidates&#34; under <a href="#TERMINOLOGY" class="podlinkpod"
>&#34;TERMINOLOGY&#34;</a>.</p>

<dt><a name="initial_case_sensitive"
>initial_case_sensitive</a></dt>

<dd>
<p>A boolean that makes initializing case sensitive, e.g., &#34;A&#34; and &#34;a&#34; will be not grouped together under &#34;A&#34;, but separately under &#34;A&#34; and &#34;a&#34;. This defaults to 0.</p>

<dt><a name="initial_ignore_diacritics"
>initial_ignore_diacritics</a></dt>

<dd>
<p>A boolean that makes initializaing ignore diacritical marks, e.g., &#34;A&#34;, &#34;&#193;&#34;, &#34;&#192;&#34;, and &#34;&#197;&#34; will all be grouped under the base character of &#34;A&#34;. This defaults to 1.</p>

<dt><a name="initial_prefix"
>initial_prefix</a></dt>

<dd>
<p>A string (generally a tag, possibly a macro) used to prefix the initials. When this is set it causes the module to perform initial lettering. By default this is not set and initial lettering is not performed.</p>

<dt><a name="initial_re"
>initial_re</a></dt>

<dd>
<p>A string used to override the default regular expression&#8212;<code>([\p{L}\p{N}])</code>&#8212;that controls initializing. The default matches any one character that is classified as a letter or digit, but you may change this as you wish. Be sure to enclose the part you want initialized in capturing parenthesis: <code>()</code>.</p>

<p>For example, if you want last names that start with &#34;Mc&#34; to have their own initial and also perform the default initializing, use:</p>

<pre>  (Mc|[\p{L}\p{N}])</pre>

<p>You can also initial <i>any</i> character by using:</p>

<pre>  (\X)</pre>

<p>Lastly, keep in mind that initializing is not restricted to one character; you can do any number:</p>

<pre>  (\X{2})</pre>

<p>For more information see the Regular Expression Unicode Properties <a href="http://www.regular-expressions.info/unicode.html" class="podlinkurl"
>here</a> and Perl&#39;s regular expression docs <a href="http://perldoc.perl.org/perlre.html" class="podlinkurl"
>here</a>.</p>

<dt><a name="modifier"
>modifier</a></dt>

<dd>
<p>A user-defined subroutine that modifies the entire data set (stored in <code>$_</code>). It is called after all other processes have completed; however, it will also be called before the initializing process when it is ran. An argument is passed to this routine that indicates where in the process flow it has been called: if 0, it is being called prior to initial lettering; if 1, it is being called after the entire set of processes. This can be used to perform different sets of modification like so:</p>

<pre>  modifier =&#62; sub {
        my $final = shift;
        if ($final) {
                ### Modify the data at the very end of the process.
        }
        else {
                ### Modify the data prior to initializing.
        }
  }</pre>

<dt><a name="move_uninitialized_to_top"
>move_uninitialized_to_top</a></dt>

<dd>
<p>This prevents candidates that did not meet the initializing criteria from being moved to the top. This is useful when working with hierarchical data that should not be moved. This defaults to 1.</p>

<dt><a name="pages"
>pages</a></dt>

<dd>
<p>This is supplied as an array reference and each element specifies the following separated by colons:</p>

<ol>
<li>The multi-part page number (p1-p6) to extract from the <code>&#60;rsv&#62;</code> macros.</li>

<li>The print-style for the page number.</li>

<li>The prefix for the page number.</li>
</ol>

<p>This defaults to <code>[qw( p4:an:{p4} )]</code> which uses the actual page number (<i>p4</i>), displays it as an arabic numeral (<i>an</i>), and prefixes it with a <code> {p4} </code> tag (<i>{p4}</i>). Thus, an entry on the first page would be followed by: <code>{p4}1</code>.</p>

<p>When pages are specified their print-styles and prefixes default to &#34;<code>an</code>&#34; and &#34;<code>{pX}</code>&#34; respectively, where <i>X</i> is the multi-part page number (1-6). Thus, <code>[qw( p3 )]</code> is the same as <code>[qw( p3:an:{p3} )]</code>.</p>

<p>What if you need a p3 that prints in uppercase letters followed by an arabic numeral p4 (A1, A2, ..., B1, etc.)? Use <code>[qw( p3:ABC p4 )]</code> to get output like <code>{p3}A{p4}1</code>.</p>

<dt><a name="strip_eb_ep"
>strip_eb_ep</a></dt>

<dd>
<p>A boolean that determines if <code>&#60;eb&#62;</code> and <code>&#60;ep&#62;</code> macros (with or without arguments) are stripped from the file. This defaults to 1.</p>

<dt><a name="strip_keeps"
>strip_keeps</a></dt>

<dd>
<p>A boolean that determines if keep macros are stripped from the file. This will remove the following macros (with or without arguments): <code>&#60;ks&#62;</code>, <code>&#60;ke&#62;</code>, <code>&#60;vk&#62;</code>. This defaults to 1.</p>

<dt><a name="strip_pgrafs"
>strip_pgrafs</a></dt>

<dd>
<p>A boolean that determines if pgrafs (unescaped percent signs) are stripped from the file. This defaults to 1.</p>

<dt><a name="tmp_dir"
>tmp_dir</a></dt>

<dd>
<p>Allows the user to change the directory where temporary files are created. This defaults to <code>/tmp</code>.</p>
</dd>
</dl>

<dt><a name="process"
>process</a></dt>

<dd>
<p>Executes the processes defined above.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="ERROR_REPORTING"
>ERROR REPORTING</a></h1>

<p>Because CITI&#39;s output runs together and is often verbose errors are made obvious as seen below:</p>

<img src="images/error.jpg" style="margin-left:1em;">


<h1><a class='u' href='#___top' title='click to go to top of document'
name="SORTING"
>SORTING</a></h1>

<ul>
<li>Use the &#34;sort-a&#34; CITI process to ignore accents during sorting.</li>

<li>For more information see &#34;Sorting the Unicode Character Set&#34; in the CITI manual and the <a href="http://userguide.icu-project.org/collation" class="podlinkurl"
>Collation section of the ICU user guide</a>.</li>
</ul>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="EXAMPLES"
>EXAMPLES</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Single-Level"
>Single-Level</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Before"
>Before</a></h3>

<img src="images/single_default_before.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_defaults)"
>After (with defaults)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new-&#62;process;</pre>

<img src="images/single_default_after.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_initial_lettering)"
>After (with initial lettering)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new(
    initial_prefix =&#62; &#39;{i}&#39;
  )-&#62;process;</pre>

<img src="images/single_default_after_initial.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_custom_initial_lettering(8212)2_leading_letters_or_digits)"
>After (with custom initial lettering&#8212;2 leading letters or digits)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new(
    initial_prefix =&#62; &#39;{i}&#39;,
    initial_re =&#62; &#39;([\p{L}\p{N}]{2})&#39;,
  )-&#62;process;</pre>

<img src="images/single_default_after_initial2.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_initial_lettering_and_modifiers_to_initial_cap_and_group_numerics)"
>After (with initial lettering and modifiers to initial cap and group numerics)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new(
    initial_prefix =&#62; &#39;{i}&#39;,
    modifier =&#62; sub {
        my $final = shift;
        if ($final) {
            ### Group all numbers under &#34;Numerics&#34;
            s/^\{i\}\p{N}+\n/{i}Numerics/m;
            s/^\{i\}\p{N}+\n//gm;
        }
        else {
            ### Initial cap entries prior to initializing
            s/(?&#60;=\{e\}\x1f)(\p{L})/uc $1/eg;
        }
    },
  )-&#62;process;</pre>

<img src="images/single_default_after_num_mod.jpg" style="margin-left:1em;">


<h2><a class='u' href='#___top' title='click to go to top of document'
name="Single-Level_using_2_mult-part_page_numbers_(p3_and_p4)"
>Single-Level using 2 mult-part page numbers (p3 and p4)</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Before"
>Before</a></h3>

<img src="images/single_multi_pp_before.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_a_differently_formatted_p3_and_initial_lettering)"
>After (with a differently formatted p3 and initial lettering)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new(
    pages =&#62; [qw(p3:ABC p4)],
    initial_prefix =&#62; &#39;{i}&#39;,
  )-&#62;process;</pre>

<img src="images/single_multi_pp_after_initial.jpg" style="margin-left:1em;">


<h2><a class='u' href='#___top' title='click to go to top of document'
name="Multi-Level"
>Multi-Level</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Before"
>Before</a></h3>

<img src="images/multi_default_before.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_defaults)"
>After (with defaults)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new-&#62;process;</pre>

<img src="images/multi_default_after.jpg" style="margin-left:1em;">


<h3><a class='u' href='#___top' title='click to go to top of document'
name="After_(with_selective_initial_lettering)"
>After (with selective initial lettering)</a></h3>

<pre>  XPP::CITI::Automate-&#62;new(
    initial_prefix =&#62; &#39;{i}&#39;,
    initial_candidates =&#62; [&#39;{e l=&#34;1&#34;}&#39;],
    move_uninitialized_to_top =&#62; 0,
  )-&#62;process;</pre>

<img src="images/multi_initial_after.jpg" style="margin-left:1em;">

</body></html>
